/**
 * 调用大语言模型API获取生成结果
 * @param {string} system_prompt - 系统提示词，定义AI的角色和行为
 * @param {string} user_prompt - 用户输入的内容
 * @returns {Promise<string>} AI生成的回复内容
 */
async function get_llm_result(system_prompt, user_prompt) {
  // 发送POST请求到AI API
  const response = await fetch("https://api.aibh.site/v1/chat/completions", {
    method: "POST",
    headers: {
      Authorization:
        "Bearer sk-v301gFi1IVPXCaUpOuMSu19tYRJgQVZ0OrI2k7Bi8SYomPe5",
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      model: "gemini-2.5-pro",
      messages: [
        { role: "system", content: system_prompt },
        { role: "user", content: user_prompt },
      ],
    }),
  });

  // 解析响应数据
  const data = await response.json();

  // 提取AI回复内容并返回
  const llm_result = data.choices[0].message.content;
  return llm_result;
}

/**
 * 将小说文本按照标点符号分段并分组
 * @param {string} novel_text - 输入的小说文本
 * @param {number} split_length - 分割长度，默认为1000
 * @returns {Array<string>} 包含两个字符串的数组，如果文本长度小于分割长度，第二个字符串为空
 */
function split_novel_text(novel_text, split_length = 1000) {
  // 如果文本长度小于分割长度，直接返回原文本和空字符串
  if (novel_text.length <= split_length) {
    return [novel_text, ""];
  }

  // 使用正则表达式按照句号、问号、感叹号进行分段
  const segments = novel_text
    .split(/([。？！])/)
    .filter((segment) => segment.trim() !== "");

  // 重新组合分段，确保标点符号附加到前一个段落
  const paragraphs = [];
  for (let i = 0; i < segments.length; i += 2) {
    if (i + 1 < segments.length) {
      paragraphs.push(segments[i] + segments[i + 1]);
    } else {
      paragraphs.push(segments[i]);
    }
  }

  // 将段落分成两组
  let group1 = "";
  let group2 = "";
  let current_length = 0;
  let use_group1 = true;

  for (const paragraph of paragraphs) {
    // 如果当前组加上这个段落会超过分割长度，切换到另一组
    if (use_group1 && current_length + paragraph.length > split_length) {
      use_group1 = false;
      current_length = 0;
    }

    if (use_group1) {
      group1 += paragraph;
      current_length += paragraph.length;
    } else {
      group2 += paragraph;
    }
  }

  return [group1, group2];
}

/**
 * 从Markdown代码块中提取并解析JSON内容
 * @param {string} markdown_str - 包含JSON的Markdown格式字符串
 * @returns {object|null} 解析成功返回JSON对象，失败返回null
 */
function extract_json_from_markdown(markdown_str) {
  try {
    // 移除Markdown代码块标记
    const json_str = markdown_str
      .replace(/^```json\s*/, "") // 删除开头的```json
      .replace(/\s*```$/, ""); // 删除结尾的```

    // 解析并返回JSON对象
    const json_obj = JSON.parse(json_str);
    return json_obj;
  } catch (error) {
    console.error("JSON解析失败：", error.message);
    return null;
  }
}

/**
 * 将小说文本改写为指定人称视角
 * @param {string} novel_text - 原始小说文本
 * @param {number} perspective_num - 目标人称编号（1=第一人称，2=第二人称）
 * @returns {Promise<object>} 改写后的小说内容对象
 */
async function rewrite_perspective(novel_text, perspective_num) {
  // 验证并确定目标人称
  let perspective;
  if (perspective_num === 1) {
    perspective = "第一人称";
  } else if (perspective_num === 2) {
    perspective = "第二人称";
  } else {
    console.log("错误：请输入1（第一人称）或2（第二人称）");
    return;
  }

  // 构建AI系统提示词
  const system_prompt = `
# 角色
你是一个小说改写大师，专门进行人称视角转换

# 任务
1. 阅读小说全文，识别主角
2. 将小说改写为${perspective}视角
3. 保持原文的描述风格和情节不变

# 输出要求
1. 使用JSON格式：{"adapted_novel":"改写后的内容"}
2. 必须使用中文输出`;

  // 调用AI服务进行改写
  let llm_result = await get_llm_result(system_prompt, novel_text);

  // 解析并返回结果
  llm_result = extract_json_from_markdown(llm_result);
  llm_result = llm_result.adapted_novel;
  console.log(llm_result);
  return llm_result;
}

/**
 * 根据用户指定的角色名称映射改写小说中的角色名字
 * @param {string} novel_text - 原始小说文本
 * @param {Array<Object>} novel_name - 原始角色名称列表，格式：[{id, name}]
 * @param {Array<Object>} adapted_novel_name - 用户指定的新角色名称列表，格式：[{id, name}]
 * @returns {Promise<object>} 改写后的小说内容对象
 */
async function rewrite_main_roles_name(
  novel_text,
  novel_name,
  adapted_novel_name
) {
  let detail_requirement = ""; // 存储改写指令
  let have_name_list = []; // 记录已指定新名字的角色ID

  // 处理用户已指定新名字的角色
  for (let name_item of novel_name) {
    for (let adapted_name_item of adapted_novel_name) {
      if (name_item.id === adapted_name_item.id) {
        have_name_list.push(name_item.id);
        detail_requirement += `- 把**${name_item.name}**改为**${adapted_name_item.name}**\n`;
        break;
      }
    }
  }

  // 处理用户未指定新名字的角色（由AI从名字库中选择）
  for (let name_item of novel_name) {
    if (!have_name_list.includes(name_item.id)) {
      detail_requirement += `- 判断**${name_item.name}**的性别，从名字库中选择合适的名字替换\n`;
    }
  }

  // 构建AI系统提示词
  const system_prompt = `
# 角色
你是一个小说改写大师，专门负责角色名称替换

# 任务
阅读小说全文，按照以下要求改写角色名称：
${detail_requirement}

# 名字库
## 男性名字库
陆沉舟、萧临风、周墨白、顾昀、沈星野、林淮、傅寒声、谢云川、程野、季宴礼、秦砚、贺凛、宋时屿、裴焰、陆西城、沈宴、楚临渊、季淮安、周予琛、韩骁

## 女性名字库
苏晚晴、唐柠、江疏月、许知意、阮软、温如霜、黎昭、乔曦、叶听澜、洛栀、清欢、林岁晚、温念、乔晚、苏棠、宋知意、许星遥、姜眠、夏栀、白芷

# 输出要求
1. 使用JSON格式：{"adapted_novel":"改写后的内容"}
2. 保持原文描述风格不变
3. 必须使用中文输出`;

  // 调用AI服务进行角色名称改写
  let llm_result = await get_llm_result(system_prompt, novel_text);

  // 解析并返回结果
  llm_result = extract_json_from_markdown(llm_result);
  llm_result = llm_result.adapted_novel;
  console.log(llm_result);
  return llm_result;
}

/**
 * 对小说文本进行降重改写，降低重复度
 * @param {string} novel_text - 原始小说文本
 * @returns {Promise<object>} 降重改写后的小说内容对象
 */
async function rewrite_novel(novel_text) {
  // 构建AI系统提示词
  const system_prompt = `
# 角色
你是一个小说改写助手，专门进行文本降重处理

# 任务
你的任务是将小说的句式变换降重处理，请：
1. 调整句子之间的逻辑关系表达
2. 重组句子成分顺序，更改语法结构
3. 合并或拆分句子 
# 注意
1. 尽量保持小说文本长度不变
2. 小说的描述风格尽量和原风格保持一致
3. 请按json格式输出，格式为{"adapted_novel"："xxxx"}
4. 输出的文本必须是中文！`;

  // 调用AI服务进行降重改写
  let llm_result = await get_llm_result(system_prompt, novel_text);

  // 解析并返回结果
  llm_result = extract_json_from_markdown(llm_result);
  llm_result = llm_result.adapted_novel;
  console.log(llm_result);
  return llm_result;
}

/**
 * 为小说生成精彩开头并与原文融合
 * 分三步完成：1.切分正文 2.生成开头 3.融合开头与原文
 * @param {string} novel_text - 原始小说文本
 * @returns {Promise<object>} 添加开头后的完整小说内容对象
 */
async function add_opening(novel_text) {
  // 构建生成开头的AI提示词（包含多种开头结构模板）
  const get_opening_system_prompt = `
# 角色
你是你是一个专业的引流视频创作者，需要根据用户提供的小说文本，根据剧情写精彩、吸引人的短视频开头文案。

# 步骤
1. 你需要阅读全文，从小说里找到有吸引力的引流情节
2. 基于引流情节，并学习我给你的开头示例，找到最适合这篇小说的示例，模仿并写出1个精彩开头

# 开头示例
## 反转结构
### 结构特征：你一个xxx（设定或者一件事），却被xxx（和这个设定反过来的事情），就连xxx（具体怎么反转做了什么事），甚至xxx（递进关系），然而xxx（递进关系），我却xxx（反转），只因xxx（讲原因）
### 具体案例：
我一个重度精神病，却被全国人奉为神明，就连我说我是派大星他们都深信不疑，还要陪我一起去海里抓水母，只因我...                        
我身为奥特曼，却从不打怪兽，反而一心想要毁灭全人类，只因这个世界迪迦奥特曼因暴力被举报下架，全网家长顿时一片欢呼，然而却...                            
你相貌面善，却没人敢靠近你分毫，一个眼神便能把小区里最凶恶的狗，吓的当场大小便失禁，蚊子臭虫都不敢靠近你身边3米之内，而你虽...                            
平时连蚂蚁都不敢踩的我，却在一夜之间宰了十万头牛，就在所有人以为我会拿肉卖钱跑路时，我却选择直接把肉烂在自家仓库，村里都骂我是个疯子，说父母刚死我就败光家产，就连初恋女友也以为我是为了凑彩礼钱，随即让我死了这条心，就算宰光家里的牛也凑不够五千万...                            
你高考280，却被国科大特邀入学，可四年大学你却交了四年白卷，成为了全校师生眼中的顶级学渣，而他们不知道的是，你用4年时间读完了学校图书馆里的所有书，并且每本都能做到倒背如流，只因这是系统留给你的任务，四年的时间...                            

## 无脑结构1
### 结构特征：为了证明xxx（设定人或者一件事），可以xxx（意料之外的设定），竟xxx（和这个人或事反过来），不仅xxxx（举例子），而且xxxx（举例子），甚至xxxx（递进关系），此刻...（反转）
### 具体案例：
男人为了证明纹身一点都不疼，竟不打麻药在身上纹了个睁眼关公，后背则是一副九龙拉棺，龙头上坐着的是哪吒抽龙筋，棺内躺着的...  
男人为了证明黑狗血可以辟邪，竟用黑狗血在身上纹满了整个地府，左肩阎罗，右肩判官，前胸无常，后背马面，地藏孟婆护在腰间...  
我为了证明癌细胞是不死的存在，竟一夜之间在体内植入37种病毒，只因...  
为了让大家知道赌博的危害，我开直播在奥城想让自己输个底朝天，为此我特意选了一位全场吸金率最高的何官发牌，本以为这场稳了，不料...  
为了证明吃蛆非常有营养，我趁着夜晚在茅坑里面仔细挑选，小的不要只挑选大的，务必做到颗颗爆浆，只因...  
男人为了专升本可以成功，竟将数百套机甲图纸上报给了国家，其中有力量攻击性的火焰战甲，和敏捷速度型的蓝点战甲，以及...  

## 无脑结构2
### 结构特征：做过xx（设定或者一件事）的都知道，XX不仅xxxx（举例子），而且xxxx（举例子），甚至xxxx（递进关系），而我却...（反转）（接正文）
### 具体案例：
杀过人的都知道，毁尸灭迹是很重要的一环，但更重要的却是如何跑路，怎么让所有人都抓不到你，而偏偏你却反其道而行之，在将证据摆在明面上，甚至主动自首，只因我想要一场轰动的审判。  
睡过棺材的都知道，那里面是又黑又潮，空间还逼仄狭小，此刻我却在其中安然入睡，甚至觉得那是世上最舒服的地方，只因我在逃避现实的压力。  
追过老师的都知道，那种不仅漂亮学历还高的老师最难搞，但作为校草和校霸的我偏不信这个邪，于是我主动请她喝茶，甚至当着所有人的面公然求婚，只因我想要打破这个禁忌的界限。  
睡过哥布林的都知道，他们虽是低等的智慧种族，却能与诸天万族强行串种，上到神圣的巨龙血脉，下到卑贱的底层社畜，只要大小合适，任何母体都会沦为可怕的繁衍工具，只因我在其中找到了意外的力量。  
经常请神的都知道，神上身的时候有多猛，而我第一次请神是在大学课堂上，我因为对神明的敬畏选择了最拯救人的方式，甚至把课堂变成了祭坛，想要传递我的信仰。  
和超级富二代当过舍友的都知道，喊他一声义父是应当的，我穿越来的第一天，就看到自己的义父在和男女主过剧情，此刻我却决定插手进他们的生活，甚至想要改变他们的命运。  
当过反派的都知道，天命主角确实难搞，怕一个不小心就会被他给搞死，所以当别的反派冒着生命危险跟主角斗智斗勇时，我却选择了投诚，甚至帮他打败所有敌人，只因我想要重新书写我的人生。  
给皇帝当过儿子的都知道，当的好荣华富贵万人之上，当不好就是人头落地，而我第一次穿越当皇子，就触碰了父皇的禁忌，奸人将我推向深渊，而我却在绝境中逆袭。  
当过大哥的都知道，大嫂很润，这天我却选择了站出来保护她，甚至在众目睽睽之下对抗所有敌人，只因我明白守护的意义。  

## 无脑结构3
### 结构特征：你（男人/我）第一次xx（设定一件事）竟xxx（意料之外的举动），不仅xxx（举例子），甚至xxx（递进关系），然而xxx（反转），此刻...（接正文）
### 具体案例：
你第一次直播就收了一个亿的礼物，其他主播对大哥都是百般讨好，而你直播的内容就是咒别人死，你咒的越狠，别人刷的越起劲，甚至你把粉丝的祖宗十八代都骂过了，他还笑嘻嘻的说，大师你对我真好，而你原本是一个普通的上班族，然而现在却成为了网络传奇。  
我一次直播就算计了三百亿吃瓜网友，当所有人都认为我开直播去KTV唱歌时，我却转身喊了十个小妹妹到包间帮我写作业，而当遇到无良车主人肉占车位时，我直接披上保安制服把他轰走，这一举动让所有网友惊呆了。  
你第一次直播就把80万观众吓得当场嗝屁，可就是这样如此诡异的直播，不仅没有人出来制止反对，反而还吸引了全球76亿人在线观看，而你直播的内容就是在恐怖片场景中与鬼怪对话，让人无比紧张。  
我每直播一次就得获刑八十年，如果玩的太过火还会被直接枪毙，以至于关注我的全都是警察，而我原本是喝奶都要把瓶盖舔干净的屌丝，然而穿越后我却变成了一个无所畏惧的直播王者。  
你每直播一次就会被拘留，兴奋起来更是会直接被判无期，以至于你的直播间粉丝一大半都是警察，只因你获得了法外狂徒张三系统，只要你通过系统提升人气，就能解锁各种神奇能力，哪知道这竟然成了你逆袭人生的契机。  
僵尸妹子第一次穿嗨丝逛街，就遇到了正在巡逻的驱魔师，然而奇怪的是，驱魔师不但没有对她大打出手，反而好心的给她检查起了身体，令她感到难以置信。  

## 无脑结构4
### 结构特征：全国14亿人都被xx骗了（一个人或者一件事），其实xx（一个人或者一件事），并不是xxx（和这个人或事反过来），而是xxx（没听过的版本），当年...（接正文）
### 具体案例：
全国13亿人都被如来给骗了，他当年打死的不是六二猕猴，而是孙悟空，当年真假美猴王要去见如来时，六耳猕猴曾对着悟空说...                                
全国13亿斗罗粉都被玉小刚骗了，表面上他是一个严格和善的大师吗，但实际他却是个狗眼看人低的伪君子，刚穿越到...                                
全国13亿人都被曹雪芹骗了，红楼梦其实讲述的是死人的故事，大观园就是一个大坟场，便随着我这话说出来，台下一片哗然...                                
全国13亿人都被刘备骗了，宅心仁厚不过是他收买人心的手段，真实面目却是一个阴险狡诈的大耳贼，穿越到三国后，你...                                

## 对比结构
### 结构特征：我明明xxx（一个观点），却xxx（却违背这个观点的例子）
### 具体案例：
你明明从小帅到大，但你无论换多少人表白都会被拒绝，而如今拒绝你表白的几个女人却都同时上门找到你，青梅竹马叶叶馨璃，心里明明互相喜欢，但却因为自己的傲娇性格，在你表白的几天后都没有理你，可她却不知道你来敲门的最后一天，是想告诉她自己搬家的事情，当她回过神来找你的时候，却被自己父母告知你已经搬走了。  
我明明把病人治愈了，病人却告我要杀他，而证人则是那些被我治愈的人，他们曾经患得不是癌症就是艾滋，此刻却联名作证说我谋财害命，而关键证据更是我舔了3年的女神提供。  
我明明在寺院修行了7个两年半，却还道欠了佛祖200年功德，只因我经常偷吃佛祖贡品，还时常将手伸进功德箱偷遣，不对，是向佛祖化缘，师兄们超度亡灵都是念诵佛经，我超度亡灵却是一边吹唢呐一边喊麦，见我干的缺德事太多，我的师傅一怒之下把我赶出了寺院，虽然我已年满20，但是除了敲木鱼啥也不会。  
校花明明讨厌所有男人，却对我一个瞎子格外在意，甚至就因为把我推倒了，就非得闹着要嫁给我，而这一切只因那该死的系统。  
你明明是个凡人，可整个仙界却没人敢惹你，并且大家都叫你仙界五五开，某日有人问你和玉帝谁更厉害，你淡定的说道五五开吧，有人又问道你和如来谁厉害，还是五五开，而你之所以如此自信，全是因为你获得了屁也不会却和谁都能五五开的能力。  

## 铺垫结构1
### 结构特征：喝醉酒后xxx（一个借口），却意外xxx（一件离谱的事情），没想到xxx（意料之外的结果），甚至xxx（递进关系），然而xxx（铺垫），却xxx（反转），此刻...（接正文）
### 具体案例：
男人阴差阳错之下竟然向美女师尊告白了，本以为就要被废去修为逐出师门，没想到师尊竟然答应和他谈恋爱。看着师尊满脸期待的样子，男人根本不敢说他一开始是想跟小师妹告白的。  
我喝多了给校花发短信表白，结果群发给了通讯录里所有人，本以为要社死当场，可第二天醒来后，不仅暗恋我的小学妹，回复了几十条示爱短信，就连青梅竹马也答应了做我女朋友。  
我喝多了给女神表白，结果错发给了女神老师，刚想点测回，一紧张点成删除，正想着如何解释为好，没想到女神老师却回复先从朋友开始，我慌了，老师却笑了，第二天她主动约我喝茶。  
没想到喝醉酒后，我竟然被前女友的妹妹给睡了，醒来后才发现身边躺着一丝不挂的绝色佳人，心中暗想自己这次真是喝得太过了，而那绝色佳人却微微一笑，给我递上了一张纸条。  

## 铺垫结构2
### 结构特征：我吹牛逼说xxx（借口说一件离谱的事情），没想到隔天就xxx（意料之外的结果），就连xxx（举例子），甚至xxx（递进关系），然而xxx（铺垫），却xxx（反转），此刻...（接正文）
### 具体案例：
我吹牛逼，说秦始皇将不日飞升，全网都骂我是个傻逼，可半个月后，所有人都被我狠狠的打了脸，秦始皇竟真的证道飞升了，我是名脑刘晚期患者，就在我准备等死时，竟获得了可以穿越时空的能力。  
我喝酒催牛逼说自己啥都能修，隔天酒友就拖来一台损坏的战斗机让我修，就在他一脸戏谑的想看我出洋相时，我却一口答应他接下了这个单子，这会轮到他懵逼了，原本我只是个修车工，却在无意间发现了隐藏的修理天赋。  
你老婆对闺蜜吹牛，说你那个能力特别强，一晚83次，那天晚上你和老婆深入交流时，发现自己可以金枪不倒，你他喵惊呆了，幸亏老婆没说你有三个肾，要不然以后你就不用狂炫肾宝了，只因你老婆觉醒了超强的情感技能。  

## 直接结构1
### 结构特征：我意外(发现/穿越/获得/觉醒)xxx（一句话讲明重点），然而xxx（反转结构公式），甚至xxx（递进关系），但他们都不知道的是xxx（铺垫），此刻...（接正文）
### 具体案例：
你穿越到一个存在超级英雄的平行世界，这里的樱花国有假面骑士，米国有恐龙战队，华夏国有铠甲勇士，可樱花国内部纷争不断，导致他们的假面骑士被怪物团灭，整个国家也因此沉入深海，之后怪兽又将矛头转向华夏，十一位铠甲勇士拼死抵抗才勉强守佳防线，虽然你是刑天铠甲的继承人，但你却隐藏身份并没有参加战斗，因为你想要寻找真正的力量。  
穿越后我发现汉语竟是这个世界的上古禁咒，只要用普通话说出来就可成功施法，一个百岁老者仅是说了个雷字，晴朗的天空顿时乌云密布电闪雷鸣，接着他又说了个雨字，原本干涸的沙漠瞬间下起了倾盆大雨，看到这一幕后我直接惊呆了，这不就是普通话吗，于是我忍不住说了草字，荒芜的草地上瞬间长满了野草生机盎然，然而随着我不断施法，越来越多的强者开始盯上我。  
我穿越到大明，还有五天就要被砍头了，但我却非常兴奋，只因我被砍头后就会破碎虚空永生不朽而且在诏狱里我还遇到了一个人傻钱多的富二代只要我每天给他上上课吹吹牛就能每天好吃好喝等着被砍头，然而他却不知道我真正的身份。  
我发现我的电脑居然能连接二维世界，二维的像素小人还把我奉为神明，因为我可以把现实中的物品赐予他们，而小人献给我的祭品也能进入现实，不过让我没想到的是，他们第一次献的祭品，直接把我给吓成傻逼了，刚开始，我试着将一把普通的刀送入二维世界，结果他们居然以为这是无上神器，纷纷跪拜。  
我意外获得鱼鱼果实，却被众人嘲讽是个离不开水的废物果实，殊不知鱼鱼果实可是恶魔果实的天花板，食用后不仅能让人形态拥有高属性四维，兽形态甚至拥有风火雷电四种极致能力，随意一击便能造成天灾级攻击，人兽形态更是有无敌之姿，前世的鱼鱼果实拥有者凯多，更是被称为海陆最强生物，而我现在却必须在众人面前证明我的价值。  

## 直接结构2
### 结构特征：这个世界每个人都会xxx（一句话讲明重点），有的xxxx（举例子），xxxx（举例子），甚至xxx（递进关系），xxx（铺垫），然而明明xxx却xxx（反转），但...（接正文）
### 具体案例：
这是一个由异能者统治的赛博朋克世界，所有人都有机率成为强大的升格者，有觉醒成为擅长战斗的武者，还有擅长数据运算的黑客，甚至有擅长鼓舞人心的领导者，而我一觉醒来却成为神豪反派，由于知道不久后会被女主联合男主一脚干废，我便觉醒了操控财富的能力。  
这是一个诡异的世界，这个世界的鬼成年后，都要来人间找工作，有一个月工资八百冥币的，加人头提成的缆车砍头员，有一个月接客三千，加阳气提成的红衣站街鬼，还有撞死一个人，五十冥币的疯狂出租车鬼，而大部分人类都跑不过被屠杀的命运，直到身怀诡技的神选者出现，打破了这个循环。  
这是一个越古老就越强大的时代，可来自10亿年前的我，却被别人当成了最垃圾的守护灵，还说宁可选一条只活了3年的狗，也不选来自10亿年前的我，可他们不知道的是，这一切只因我实在是太古老了，以至于觉醒仪都无法判定我的等级，这也让世人以为我只是一个最低等的反击守护灵，然而我却拥有无与伦比的古老智慧。  
这是一个人类与异兽共存的世界，击杀异兽后国家会对男人分配老婆，膀大腰圆实力强悍的女汉子不仅惨遭众人哄抢，更是自带百万嫁妆，而身材苗条实力较弱的美女却遭人嫌弃，因为她们在异兽眼中就是如同婴儿一样的可口，但我却通过智慧和策略赢得了她们的青睐。  
这个世界每个人，年满六岁就会召唤属于自己的机甲，有人觉醒赵云机甲，手持长枪七进七出横扫千军，有人觉醒关羽机甲，凭借一柄青龙偃月刀一骑当千，还有人觉醒盘古战甲，一斧开天辟地斩尽浩瀚星河，可我却在众人面前召唤出了传说中的“木头”，不被看好，但实际上我却拥有掌控自然的能力。  

## 直接结构3
### 结构特征：我重生成了xxx，而且还是xxx（一句话讲明重点），不仅xxxx（反转），而且xxxx（递进，甚至xxxx（铺垫），此刻...（接正文）
### 具体案例：
我重生成了一条狗，却被人当做神明供奉，只因我虽然是狗却已经活了68年之久，在别人看来我已经开了灵智成了精，但却不知道实际上我                                
你重生成了一头猪，而且还是猪场的老大，你每天的目标就是                                
我重生成了一只乌龟，开局竟被孙悟空捡到，那猴子带着我一起来到蓬莱仙岛准备拜师学艺，没想到菩提老祖见到我，却嫌弃我资质太差，直接把我                                
我重生后变成了一台机甲，而且还是只有空壳没有肉体的那种，但我却凭借强大的战斗意识，多次暗中帮助驾驶员拯救这个被怪兽入侵的世界                                
我重生后变成了一条红龙，还是一只有着三对龙角全身金色鳞甲的红龙，而且我还发现自己拥有掌控能力的权能，不仅可以掌控宏观领域的引力和电磁力，就连微观领域的强核力以及弱核力，我都可以轻易掌控，然而此时                                
你重生成为宇宙中一颗荒凉的星球，第一件事就是引来小行星撞自己，可经过多次实验，你发现自己竟然是一颗死星，不仅没有大气层，甚至表面温度都高达一千五百度，因此                                                    

# 要求
1. 请按json格式输出，格式为{'brilliant_start':'xxx'}
2. 请找出不同的引流情节，用不同的开头结构进行生成，保证生成开头的多样性
3. 生成的精彩开头请使用第一人称
4. 生成的精彩开头必须是中文`;

  // 构建融合开头与原文的AI提示词
  const inter_opening_novel_prompt = `
# 角色
你是你是一个小说改写大师，你将改写小说使其适合在短视频平台进行传播，现在我会给你一篇小说的精彩开头，以及小说正文，你需要通过对小说正文进行改写，以完成精彩开头和小说正文的融合，生产出一篇优质的小说内容

# 步骤
1. 你需要阅读精彩开头和小说正文，了解故事内容
2. 在不修改精彩开头的前提下，把精彩开头放到小说正文前
3. 对小说正文进行改写，这里你可以删除一部分内容，或者改写一部分内容，以使其可以适配开头，使得整体小说逻辑通顺，结构清晰

# 要求
1. 请按json格式输出，格式为{"adapted_novel"："xxxx"}
2. 输出的文本必须是中文！`;

  // 步骤1：切分小说正文
  let novel_text_list = split_novel_text(novel_text);
  let first_novel_text = novel_text_list[0];
  let second_novel_text = novel_text_list[1];

  // 步骤2：生成精彩开头
  let opening = await get_llm_result(
    get_opening_system_prompt,
    first_novel_text
  );
  opening = extract_json_from_markdown(opening);
  opening = opening.brilliant_start;
  console.log("生成的精彩开头：" + opening);

  // 步骤3：融合开头与原文
  let inter_user_prompt =
    "# 以下是精彩开头\n" + opening + "\n" + "# 小说原文\n" + first_novel_text;
  let llm_result = await get_llm_result(
    inter_opening_novel_prompt,
    inter_user_prompt
  );

  // 解析并返回最终结果
  llm_result = extract_json_from_markdown(llm_result);
  llm_result = llm_result.adapted_novel;
  llm_result = llm_result + second_novel_text;
  console.log(llm_result);
  return llm_result;
}

export {
  rewrite_perspective,
  rewrite_main_roles_name,
  rewrite_novel,
  add_opening,
};

const novel_text = `我是京圈最有权势的太子爷，锲而不舍地追了陆浅浅十几年。
结果她在订婚宴上为了当年抛弃她的竹马逃婚。
可是她不知道，我马上就会忘记她了。
在今年国庆节之前我觉得我的人生十分圆满，我投胎技术一流，作为京圈太子爷有权有势。
我还有个青梅竹马门当户对的未婚妻，虽然她并不是很爱我，但是在我的穷追猛打之下，她终于答应了和我订婚。
我爱了陆浅浅十几年，她是我年少时期的梦，如今终于如愿以偿。
可是天不遂人愿这五个字第一次和我扯上了关系，订婚宴当天，陆浅浅的白月光回国了。
订婚宴进行到一半的时候，陆浅浅接了个电话，然后她就要抛下我。
“云深，今天有点事，我要先离开一下。”
她拿着手机眼里都是焦急。
“浅浅，等订婚宴结束你再走好吗？”
台下宾客已经坐满，我和她都是京城世家，一举一动都被无数双眼睛盯着，如果她今天走了不知要惹出多少闲话。
陆浅浅咬了咬唇，似乎犹豫了一下，但最后还是毅然决然的开口：
“我……云深，订婚宴下个月再办好不好？现在我真的很着急，必须先离开。”
“傅青裴回来了，对吧？可以不要走吗？”
我看着她苦笑了一下。
傅青裴，我的弟弟，傅家的养子，也是陆浅浅的白月光。
她没想到我猜中了原因，脸色一瞬间惨白，她冲着我点了点头：“他在机场出事了，我现在要去机场，云深，他也是你弟弟呀。”
“订婚宴我们走个流程，耽误不了多久，晚点我和你一起去接他好不好？”
我放下尊严做出了最大的让步，提出一个可行的方法。
我知道陆浅浅忘不了他，但是今天她若走了，傅家和陆家的的颜面往哪里搁，我这个所谓的太子爷又如何继承傅家？
“不行，他在机场晕倒了，现在人联系不上，万一他真的出了什么事我会后悔一辈子。
“云深，我已经答应和你订婚了，难道订婚宴比你弟弟的命都重要吗？”
她急的快要哭了，想也不想就直接拒绝了我，然后头也不回就往会场外面跑。
台下的宾客议论纷纷，有些记者拿起相机疯狂抓拍，不用想，今天陆浅浅闹的这一出明天就得出现在头版头条。
我只觉得一股无名的怒气直冲大脑，头痛欲裂，竟然一下晕了过去。
醒过来的时候已经是晚上，我躺在医院的病床上。
林心怡坐在我身边，眼圈通红，眼泪在眼眶里打转。
“傅云深……”
她低声喊着我的名字。
“我还没死呢，把眼泪憋回去，等我死了你再哭。”
林心怡是我的发小，也是我的主治医生。
“可是你快死了，傅云深，你现在的情况，已经活不到一年了，我求你了，接受手术吧，为了陆浅浅根本就不值得。”
一边说着她把手机打开翻到了陆浅浅的朋友圈，陆浅浅刚刚发了她和傅青裴在游乐园的照片。
我看到照片上他们刺眼的笑容只觉得头晕目眩，直接吐了出来。
林心怡心疼地看着我：“傅云深，求求你接受治疗吧，何必呢？”
是的何必呢，我都快死了。
三个月前我被诊断出脑癌，如果不治疗的话，活不到一年。
林心怡联系了她的导师，提供了最新的治疗方案，经过治疗就可以保住命，但是却大概率会失忆。
之前我不想失忆，不想忘掉陆浅浅，所以一直没有接受治疗。
但是现在，看着他们的照片，我忽然有些动摇了。
傅青裴是傅家的养子，但是他从小和我还有陆浅浅一起长大。
年少的心动总是那样简单，我和傅青裴都喜欢上了陆浅浅。
但是陆浅浅喜欢的人是傅青裴，因为十五岁时她跌落水中，是傅青裴救了她。
他们曾经短暂地在一起了几天，后来傅青裴就被爷爷送出国读书，两人便不再联系。
而我和她却因为家族联姻有了婚约。
她一直不待见我，但是我爱了她不知道多少年。
大学我报了和她同一所大学。
每天早上给她送早餐，下雨了帮她打伞接送她上课。
还为了买她喜欢的小吃经常跑三条街。
我不知道我到底为了她做了多少事，但是结果是好的，她后来终于感动了，同意了和我订婚。
只不过没想到订婚宴被傅青裴搞砸了。
我就知道，从小到大，一碰到傅青裴我就倒霉。
第二天中午，陆浅浅和傅青裴一起来看我，他们挽着手看起来格外亲密。
他们是来给我道歉的，订婚宴搞成这样，我爷爷和陆家都很生气。
“哥哥，昨天我在机场有些不舒服，我也不知道昨天是你和浅浅的订婚宴，对不起，不然我就是死了也不会影响你的。”
傅青裴开始茶言茶语。
我倒是巴不得他赶紧死了，只可惜目前看来先死的人会是我。
我翻了个白眼。
“那你现在既然知道我和浅浅要订婚了，你能先把拉着的手放开吗？”
我看着他笑了一下。
他向后退了一步和陆浅浅拉开距离，脸色有些难看，然后他想起什么一样笑了：“对了哥哥，这次我回国，想要举办一场游泳派对，你记得来参加，浅浅也去。”
我听到游泳这两个字当场一怔，因为自从15岁一次高烧之后我便开始怕水。
明明小时候我是游泳健将，还进了国家队，可是自从15岁那次从昏迷中醒来，我再也没有办法克服恐惧在水中肆意的畅游了。
陆浅浅有些期待地看着我，明显想要我参加。
我无法拒绝陆浅浅，而且这个派对肯定会有很多世家弟子，不好拒绝。
我便点了点头答应下来。
派对上傅青裴和陆浅浅是当之无愧的主角，陆浅浅穿着吊带泳衣站在傅青裴身边，美若天仙。
两个人不知道低声说了什么，笑的十分开心。
林孟齐走过来敬了傅青裴一杯酒：“青裴，你总算回来了，我们大家都觉得你才配得上浅浅。”
他是林心怡的堂哥，曾经明明和我关系更好，但是不知道为什么，自从我不会游泳之后，他就和傅青裴关系亲密了起来，而对我总是冷嘲热讽。
其他人也跟着附和起来：“是呀，青裴你总算回来了。”
“浅浅都想你了，青裴，快亲一个！”
我听着他们的起哄，狠狠握住拳头，掌心都被指甲刺痛。
好在林心怡走过来组织大家一起玩起了游戏。
可是我的运气实在不好，第一轮就被我抽到了大冒险，要下水游泳。
我看着那蓝色的泳池，一阵阵眩晕感涌了上来。
我脸色现在肯定难看得很：“我……我今天不太方便，能先不下去吗？可不可以换个别的游戏？”
林孟齐听到我的话笑起来：“傅云深，你一个大男人有什么不方便的？”
“哈哈哈，你小时候游泳不是挺厉害还进了国家队吗？不要不给面子呀。”
“就下去游个泳嘛，又不是什么大事。”
众人纷纷附和。
他们只觉得我不给面子，却不知道如今我最怕水。
只不过我当时从国家队退出，并没有说出真实原因，爷爷对外只说是我作为傅家继承人，要开始学习管理知识，才不能继续在队里训练为国争光。
但是傅青裴是知道真相的，我看向他，他却只是嘲讽地勾着嘴角，一脸看好戏的表情。
果然，我就不该对这绿茶抱有任何希望，他怎么可能会帮我？
“傅云深，你到底行不行呀？你不会还因为订婚宴的事生气吧？我已经和你道过歉了。”
陆浅浅有些不耐烦的说道。
我看着周围人嘲讽的嘴角，眼睛一闭，心一横，就跳了下去。
但是在水没过我身体的时候，我的神经一瞬间紧绷起来。
我四肢僵硬无法呼吸，在水里胡乱挣扎着。
很快岸上传来他们的哄笑声。
“傅少这是在表演什么新型游法吗？”
“不愧是游泳健将，还真是别具一格。”
“这样子怎么进的国家队呢？他爷爷给他走的后门？”
陆浅浅似乎看出来我有些不对劲：“云深，你怎么了？”
傅青裴安抚地搂过她的肩膀：“我哥可是游泳天才，怎么可能出意外嘛？他在和我们闹着玩呢。”
头顶被水淹没，我只觉得肺部被灌进了好多水，整个胸腔都痛的厉害。
无法呼吸，我一点点沉入水底。
可就在这时候我听到身旁一阵水花声响起，随即就有人把我拖了起来。
可是这样的窒息感却忽然让我感觉到熟悉，这不是我第一次溺水。
我的脑子忽然涌入一段记忆。
那是十五岁的夏天，我在水底无法呼吸，却抱着陆浅浅挣扎上岸。
那时的窒息感和现在一样。
尘封的记忆浮现在脑海，我终于想起了当年的真相。
原来救了陆浅浅的人是我，并不是傅青裴。
当时泳池旁边只有我们三个人。
傅青裴和陆浅浅在岸边打闹的时候陆浅浅失足落了水。
当时我立刻跳了下去，但是在下水的那一刻忽然全身乏力，无法呼吸。
精通游泳的我竟然溺水了。
这不对劲，我忽然想起下午的时候喝了一瓶傅青裴递给我的水，应该是那水有问题！
当时我费劲全身力气才把陆浅浅带上了岸，之后我就意识不清晕倒在了岸边。
然后我就开始了持续的发烧晕厥，从此一看到水面就发晕，再也不敢下水。
当年傅青裴一直很老实乖巧，我从来没有怀疑过他，原来事情的真相竟然是这样。
我醒来的时候依旧是林心怡在我的身边。
她对我真的很好，昨天所有人都在看我笑话，看着我溺水挣扎的时候，只有她跳下来救了我。
她看着我咬了咬牙有些恨铁不成钢：“继续糟蹋身体，你连一年都活不了！”
我想了想把在水下脑中浮现出的记忆片段告诉了她：“所以那年，陆浅浅其实是我救的。”
“陆浅浅，陆浅浅，你就知道陆浅浅！你的命都快没了！”她有些生气的吼道，眼泪却溢满了她的眼眶。
说曹操曹操到，陆浅浅的电话打了进来。
林心怡愣了下，走出了房门。
这边陆浅浅劈头盖脸对我一顿骂：“傅云深，你怎么这么卑鄙，青裴好心邀请你参加派对，你就故意陷害他？青裴因为你溺水被爷爷打了个半死，别以为我不知道，当年就是你骗了爷爷，告诉他因为傅青裴你才怕水要退出国家队，你怎么什么事都要往青裴身上賴呢？如果不是因为你，青裴也不会被送出去在国外一个人孤苦伶仃的过了这么多年！”
“当年救你的人……”我想对她澄清当年的事。
结果我刚开口就被她打断，她恶狠狠的说：“你以后不要在我面前耍这种心思，我只觉得恶心！”
说完她就挂断了电话，我却拿着手机愣住。
她为什么要这么说呢？明明当年爷爷说傅青裴只是出国深造，和我落水没有任何关系。
傅青裴确实被爷爷打了，我回到傅家看到他的时候他脸上还有乌青，走路一瘸一拐的。
但是他脸上却带着笑意，看起来十分滑稽。
他极为嚣张的看着我：“就算爷爷更喜欢你又怎样？你的一切都该是我的，不管是傅家，还是浅浅。”
一边说着，他拿出一枚戒指，我一眼看出，那是我和陆浅浅一起挑的订婚戒指。
“你看，我说我觉得好看，她就送给我了，你以为你在她面前是什么？”
我忽然觉得他脸上那抹笑意是如此的刺眼。
我努力压抑着心中的怒火，只觉得脑袋里的肿瘤都快爆炸了。
好痛好痛，身心都好痛。
陆浅浅，她为什么要这么对我？
难道我对她的爱真的一文不值吗？
难道我这么多年的付出都不及傅青裴刚刚回来几天吗？
我忽然觉得林心怡说的是对的，她说傅青裴什么都不用做，只要站在那里，他就赢了。
而我不论付出什么，哪怕为了记住陆浅浅命都不要了，也只不过是一场自我感动的爱情罢了。
我找到林心怡，我对她说我要接受治疗了，哪怕失去一切记忆，因为回忆太痛了，我好想结束这一切。
林心怡听到我要手术高兴的都快要跳起来：“太好了！你小子终于清醒了！””`;

// // const novel_name = [
//   {
//     id: 1,
//     name: "程潜",
//   },
//   {
//     id: 2,
//     name: "卢希希",
//   },
// ];

// const adapted_novel_name = [
//   {
//     id: 1,
//     name: "万路",
//   },
// ];
